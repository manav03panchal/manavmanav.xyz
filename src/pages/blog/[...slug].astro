---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();
const date = new Date(post.data.date).toISOString().split('T')[0];
---

<BaseLayout>
  <article class="bg-primary">
    <div class="px-8 2xl:max-w-7xl mx-auto py-12">
      <!-- Header -->
      <header class="mb-16" data-aos="fade-up" data-aos-duration="600">
        <div class="flex justify-between items-center mb-8">
          <a href="/posts" class="text-secondary/60 text-sm hover:text-secondary transition-colors">
            ‚Üê Posts
          </a>
          <button id="theme-toggle" class="hover:text-secondary/60 text-secondary transition-colors text-xs" aria-label="Toggle dark mode">
            <span class="dark-icon hidden">Light</span>
            <span class="light-icon">Dark</span>
          </button>
        </div>
        <p class="text-sm font-mono text-secondary/50 mb-4">{date}</p>
        <h1 class="text-4xl lg:text-6xl font-bold tracking-tight text-secondary leading-tight">
          {post.data.title}
        </h1>
      </header>

      <!-- Content -->
      <div class="prose prose-lg max-w-3xl" data-aos="fade-up" data-aos-duration="600" data-aos-delay="100">
        <Content />
      </div>
    </div>
  </article>
</BaseLayout>

<style is:global>
  .prose {
    font-size: 1.125rem;
    line-height: 1.8;
    color: #161614;
  }

  .prose > * + * {
    margin-top: 1.5rem;
  }

  .prose h2 {
    font-size: 1.75rem;
    font-weight: 600;
    margin-top: 3rem;
    margin-bottom: 1rem;
    letter-spacing: -0.02em;
    color: #161614;
  }

  .prose h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: #161614;
  }

  .prose p {
    margin-bottom: 1.5rem;
  }

  .prose a {
    color: #161614;
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-thickness: 1px;
  }

  .prose a:hover {
    text-decoration-thickness: 2px;
  }

  .prose strong {
    font-weight: 600;
  }

  .prose code {
    font-family: "Geist Mono", ui-monospace, monospace;
    font-size: 0.875em;
    background: rgba(22, 22, 20, 0.05);
    padding: 0.2em 0.4em;
    border-radius: 3px;
  }

  .prose pre {
    font-family: "Geist Mono", ui-monospace, monospace;
    font-size: 0.875rem;
    line-height: 1.7;
    padding: 1.5rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 2rem 0;
    position: relative;
  }

  .prose pre code {
    background: none !important;
    padding: 0;
    font-size: inherit;
    border-radius: 0;
  }

  .prose pre code .line {
    background: none !important;
  }

  .prose pre code span {
    background: none !important;
  }

  .prose pre .copy-button {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    font-family: "Geist", sans-serif;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s, background 0.2s;
  }

  .prose pre:hover .copy-button {
    opacity: 1;
  }

  .prose pre .copy-button:hover {
    background: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
  }

  .prose pre .copy-button.copied {
    color: #4ade80;
  }

  .prose blockquote {
    border-left: 3px solid #161614;
    padding-left: 1.5rem;
    font-style: italic;
    color: rgba(22, 22, 20, 0.7);
    margin: 2rem 0;
  }

  .prose ul, .prose ol {
    margin: 1.5rem 0;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-bottom: 0.5rem;
  }

  .prose hr {
    border: none;
    border-top: 1px solid rgba(22, 22, 20, 0.2);
    margin: 3rem 0;
  }

  .prose table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    font-size: 0.95rem;
  }

  .prose th, .prose td {
    text-align: left;
    padding: 0.75rem;
    border-bottom: 1px solid rgba(22, 22, 20, 0.1);
  }

  .prose th {
    font-weight: 600;
  }

  .prose img {
    max-width: 100%;
    margin: 2rem 0;
  }

  .prose details {
    margin: 1.5rem 0;
    padding: 1rem;
    background: rgba(22, 22, 20, 0.03);
  }

  .prose summary {
    cursor: pointer;
    font-weight: 500;
  }

  .prose kbd {
    font-family: "Geist Mono", ui-monospace, monospace;
    font-size: 0.8em;
    background: rgba(22, 22, 20, 0.08);
    padding: 0.2em 0.5em;
    border-radius: 3px;
    border: 1px solid rgba(22, 22, 20, 0.15);
  }

  .prose mark {
    background: rgba(22, 22, 20, 0.1);
    padding: 0.1em 0.3em;
  }
</style>

<script>
  function addCopyButtons() {
    document.querySelectorAll('.prose pre').forEach((block) => {
      if (block.querySelector('.copy-button')) return;

      const button = document.createElement('button');
      button.className = 'copy-button';
      button.textContent = 'Copy';

      button.addEventListener('click', async () => {
        const code = block.querySelector('code');
        const text = code ? code.textContent : block.textContent;

        await navigator.clipboard.writeText(text || '');
        button.textContent = 'Copied!';
        button.classList.add('copied');

        setTimeout(() => {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      });

      block.appendChild(button);
    });
  }

  document.addEventListener('DOMContentLoaded', addCopyButtons);
  document.addEventListener('astro:page-load', addCopyButtons);
</script>
